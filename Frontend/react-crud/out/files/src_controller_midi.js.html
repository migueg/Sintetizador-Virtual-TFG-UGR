<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\controller\midi.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Analyser.html">Analyser</a></li>
                                <li><a href="../classes/Anlyser.html">Anlyser</a></li>
                                <li><a href="../classes/App.html">App</a></li>
                                <li><a href="../classes/Delay.html">Delay</a></li>
                                <li><a href="../classes/Distorsion.html">Distorsion</a></li>
                                <li><a href="../classes/Effect.html">Effect</a></li>
                                <li><a href="../classes/Envelope.html">Envelope</a></li>
                                <li><a href="../classes/Equalizer.html">Equalizer</a></li>
                                <li><a href="../classes/ErrorPage.html">ErrorPage</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/Header.html">Header</a></li>
                                <li><a href="../classes/Index.html">Index</a></li>
                                <li><a href="../classes/Library.html">Library</a></li>
                                <li><a href="../classes/LimitedKnob.html">LimitedKnob</a></li>
                                <li><a href="../classes/Loader.html">Loader</a></li>
                                <li><a href="../classes/Login.html">Login</a></li>
                                <li><a href="../classes/Midi.html">Midi</a></li>
                                <li><a href="../classes/Modal.html">Modal</a></li>
                                <li><a href="../classes/ModalDelete.html">ModalDelete</a></li>
                                <li><a href="../classes/ModalLoad.html">ModalLoad</a></li>
                                <li><a href="../classes/ModalPassword.html">ModalPassword</a></li>
                                <li><a href="../classes/ModalSave.html">ModalSave</a></li>
                                <li><a href="../classes/Navigator.html">Navigator</a></li>
                                <li><a href="../classes/Oscilador.html">Oscilador</a></li>
                                <li><a href="../classes/oscillator.html">oscillator</a></li>
                                <li><a href="../classes/Piano.html">Piano</a></li>
                                <li><a href="../classes/Profile.html">Profile</a></li>
                                <li><a href="../classes/Recorder.html">Recorder</a></li>
                                <li><a href="../classes/Reverb.html">Reverb</a></li>
                                <li><a href="../classes/Saver.html">Saver</a></li>
                                <li><a href="../classes/SignUp.html">SignUp</a></li>
                                <li><a href="../classes/Synth.html">Synth</a></li>
                                <li><a href="../classes/TableUI.html">TableUI</a></li>
                                <li><a href="../classes/Voice.html">Voice</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/App.html">App</a></li>
                                <li><a href="../modules/Delay.html">Delay</a></li>
                                <li><a href="../modules/Distorsion.html">Distorsion</a></li>
                                <li><a href="../modules/Filter.html">Filter</a></li>
                                <li><a href="../modules/filterTypes.html">filterTypes</a></li>
                                <li><a href="../modules/FX.html">FX</a></li>
                                <li><a href="../modules/Knob.html">Knob</a></li>
                                <li><a href="../modules/Navigator.html">Navigator</a></li>
                                <li><a href="../modules/OscComponents.html">OscComponents</a></li>
                                <li><a href="../modules/Piano.html">Piano</a></li>
                                <li><a href="../modules/Reverb.html">Reverb</a></li>
                                <li><a href="../modules/synth.html">synth</a></li>
                                <li><a href="../modules/types.html">types</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\controller\midi.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import commonjs from &quot;react-rotary-knob&quot;;
import { synth } from &quot;./synth&quot;;

/**
 * La clase Midi se encarga de comunicarse con el hardware de tipo MIDI
 *
 * @class Midi
 * @constructor
 * @param {synth} Synth instancia del sintetizador
 * 
 */

/**
 * Objeto midi
 * 
 * @property Midi
 * @type Object
 * @private
 */

/**
 * 
 * @property input
 * @type Object
 * @private
 */

/**
 * 
 * @property output
 * @type Object
 * @private
 */


/**
 * Diccionario de notas
 * 
 * @property notes
 * @type Object
 * @private
 */

/**
 * 
 * @property lastOn
 * @type Boolean
 * @private
 */

/**
 * Instancia del sintetizador
 * 
 * @property synth
 * @type synth
 * @private
 */

/**
 * 
 * @property ceil
 * @type Integer
 * @private
 */

/**
 * 
 * @property octave
 * @type Integer
 * @private
 */

/**
 * 
 * @property init
 * @type Boolean
 */

class Midi {
    #support;
    #midi;
    #input
    #output
    #notes
    #lastOn
    #synth
    #ceil
    #octave;

    constructor(synth){
       this.#support = false;
       this.#midi = null
       this.#input = null;
       this.#output = null;
       this.#notes = null;
       this.#lastOn = false
       this.#synth = synth;
       this.#ceil = 2;
       this.#octave = 3;
       this.init = true;
       this.fetchNotes()
       this.requestAccess(); 
       //this.handleMidiMessage = this.handleMidiMessage.bind(this)
       //this.__checkNote = this.__checkNote.bind(this)
    }

    /**
     * Realiza una petición para obtener las notas
     * 
     * @method fetchNotes
     * @async
     */
    async fetchNotes(){
        await fetch(&#x27;http://localhost:8080/notes&#x27;)
        .then(res =&gt; res.json())
        .then((data) =&gt; {
            this.#notes = data.notes[0];
        })
        .catch(console.log)
        
    }

    /**
     * Accede a la comunicación MIDI
     * 
     * @method requestAccess
     */
    requestAccess(){
        var that = this
        navigator.requestMIDIAccess()
        .then((midi)=&gt;{
            that.#support = true;
            that.#midi = midi;
            console.log(&quot;Disponible el acceso MIDI&quot;)
            midi.addEventListener(&#x27;statechange&#x27;,(event)=&gt;this.initDevices(event.target)); //detecta si se conecta o desconecta el Midi
            this.initDevices()
        },
        (err)=&gt;{
            this.#support=false
            alert(&quot;Tu navegador no soporta control por MIDI&quot;)
        })
      
    }

    /**
     * Selecciona un dispositvo MIDI para establecer comunicación
     * 
     * @method initDevices
     */
    initDevices(){
        if(this.#midi.inputs.size &gt; 0){
            var inputArray = []; //Contiene los inputs
            var outputArray = []; //Contiene los outputs

            const inputs = this.#midi.inputs.values()
            for (let input = inputs.next(); input &amp;&amp; !input.done; input = inputs.next()) { //Recorremos los inputs con el iterador
                inputArray.push(input.value)
            }

            
            const outputs = this.#midi.outputs.values();

            for (let output = outputs.next(); output &amp;&amp; !output.done; output = outputs.next()) {
                outputArray.push(output.value);

            }

            this.#input = inputArray[0]
            this.#output = outputArray[0]

            //console.log(this.#input)
            this.__showDevice(this.#input.name);
            this.#input.addEventListener(&#x27;midimessage&#x27;, (event)=&gt;{this.handleMidiMessage(event)}) //Listener para la presion de teclas
        }else{
            this.__showDevice(&quot;No hay un MIDI conectado&quot;)
        }
        
    }


    /**
     * Enseña el nombre del dispositvo MIDI por pantalla
     * 
     * @method showDevice
     * @param {string} msg 
     * @private
     */
    __showDevice(msg){
        var doc =  document.getElementById(&#x27;device&#x27;)
        if(doc){
            document.getElementById(&#x27;device&#x27;).innerText = msg
        }
        
    }

    /**
     * Manejador para los mensajes del dispositivo MIDI
     * 
     * @method handleMidiMessage
     * @param {Event} event 
     */
    handleMidiMessage(event){
        //console.log(event.data) [off/on,note,velocity]
        const NOTE_ON = 144;
        const NOTE_OFF = 128;

        var data = event.data
        var freq = this.__midiNoteToFrequency(data[1]);
       
        var key = this.__checkNote(freq)
        //console.log(&#x27;KEY: &#x27; + key)
        if(data[0] === NOTE_ON){
           if(!this.#lastOn ){
            
            if(key){
               
                if(key.length === 2 ){
                    //console.log(&#x27;Octave: &#x27; + key[1])
                    
                    if(key[1] &lt;= this.#octave &amp;&amp; key[1] &gt; this.#octave - 2){
                        var dif =  key[1] % this.#ceil;

                        if(!dif){ 
                        // console.log(&#x27;Menor white active&#x27;)
                            document.getElementById(key[0]).classList.toggle(&#x27;white-active&#x27;)

                        }else{
                            //console.log(&#x27;Mayor white active&#x27;)

                            document.getElementById(key[0]+&#x27;1&#x27;).classList.toggle(&#x27;white-active&#x27;)
                        }

                    }
                    
                    
                   
                }else if( key[2] &lt;= this.#octave &amp;&amp; key[2] &gt; this.#octave - 2){
                    var aux = key[0] + key[1]
                  
                   // console.log(&#x27;Octave: &#x27; + key[2])
                    var dif =  key[2] % this.#ceil;


                    if(!dif){
                       // console.log(&#x27;Menor black active&#x27;)

                        document.getElementById(aux).classList.toggle(&#x27;black-active&#x27;)

                    }else{
                       // console.log(&#x27;Menor black active&#x27;)

                        document.getElementById(aux+&#x27;1&#x27;).classList.toggle(&#x27;black-active&#x27;)
                    }
                    
                

                }
                this.#synth.playNote(freq)
                
            }
            
           }
            
           this.#lastOn = this.#lastOn ? false : true;
        }else{
            if(key){
                if(key.length === 2  ){
                    if(key[1] &lt;= this.#octave &amp;&amp; key[1] &gt; this.#octave - 2){
                        var dif =  key[1] % this.#ceil;
                        if(!dif  ){
                        
                            document.getElementById(key[0]).classList.remove(&#x27;white-active&#x27;)

                        }else{
                            
                            document.getElementById(key[0]+&#x27;1&#x27;).classList.remove(&#x27;white-active&#x27;)
                        }
                    }
                }else if( key[2] &lt;= this.#octave){
                  
                    var aux = key[0] + key[1]
                    var dif =  key[2] % this.#ceil;


                    if(!dif ){
                      
                        document.getElementById(aux).classList.remove(&#x27;white-active&#x27;)

                    }else{
                        
                        document.getElementById(aux+&#x27;1&#x27;).classList.remove(&#x27;white-active&#x27;)
                    }
                    

                }
                
            }
        }


    }

    /**
     * Transforma un código MIDI en una frecuencia
     * 
     * @method midiNoteToFrequency
     * @param {Integer} note Código de nota MIDI
     * @returns {Float} frecuencia
     * @private
     */
    __midiNoteToFrequency (note) {
        var value = Math.pow(2, ((note - 69) / 12)) * 440;
        if(value &lt; 98){
            
            var parse = parseFloat(Math.ceil(value * 10000) / 10000)
            if(parse === 77.7818){return 77.7817}
            if(parse === 92.4987){return 92.4986}
            if(parse === 46.2494){return 46.2493}
            if(parse === 51.9131){return 51.9130}
            return parse;
        }else if (value &lt; 988){
            return parseFloat(Math.round(value * 1000) / 1000)
        }else{
            return parseFloat(Math.round(value * 100) / 100)
        }
      
    }

    /**
     * Comprueba si una frecuencia se corresponde con una nota
     * 
     * @method checkNote
     * @param {Float} freq frecuencia
     * @returns {string} key de la nota
     * @private
     */

    __checkNote(freq){
       //console.log(&#x27;Freq:&#x27; + freq)
       if(freq &gt;= 32.7032 &amp;&amp; freq &lt;= 4186.01){ //Rango de frecuencias
        var key = &#x27;&#x27;        
        for(var n in this.#notes ){
             if(this.#notes[n] === freq){ 
                return n;
             }
 
           
        }
        return key
       } else{
           return false;
       }
    }

    /**
     * Setter de la octava
     * 
     * @method setOctave
     * @param {Integer} oct 
     */
    setOctave(oct){
        this.#octave = oct +1 
    }
}

export default Midi;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
